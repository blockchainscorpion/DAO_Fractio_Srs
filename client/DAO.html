<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fractio - DAO Governance</title>

    <!-- Core Libraries (only once) -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="js/config.js"></script>

    <!-- Module Initialization -->
    <script type="module" src="js/modules/dao/initialization.js"></script>

    <link rel="stylesheet" href="./css/dao.css" />

    <!-- User Interface -->

    <link rel="stylesheet" href="./css/dao.css" />

    <script type="module">
      import { Web3Setup } from './js/modules/core/web3Setup.js';
      import { ContractManager } from './js/modules/core/contractManager.js';
      import { StatsManager } from './js/modules/core/statsManager.js';
      import { DAOManager } from './js/modules/dao/daoManager.js';

      let daoInitialized = false;

      // Initialize the DAO interface
      async function initializeDAO() {
        try {
          // Setup web3
          const web3Setup = new Web3Setup();
          const web3 = await web3Setup.initializeWeb3();

          // Initialize contract manager
          const contractManager = new ContractManager(web3);
          await contractManager.initialize(web3Setup.getCurrentAccount());

          // Initialize DAO manager globally
          window.daoManager = new DAOManager(web3, contractManager);
          await window.daoManager.initialize();

          return true;
        } catch (error) {
          console.error('DAO initialization failed:', error);
          return false;
        }
      }

      async function initializeDAOStats() {
        try {
          // Initialize DAO first
          await initializeDAO();

          // Initialize stats manager
          const statsManager = new StatsManager(window.daoManager);
          await statsManager.initialize();
          await statsManager.loadDAOStats();
        } catch (error) {
          console.error('Error initializing DAO stats:', error);
          // Show default values
          const defaultStats = {
            totalMembers: 0,
            activeProposals: 0,
            votingPower: '0',
            quorumPercentage: 0,
          };
          Object.entries(defaultStats).forEach(([key, value]) => {
            const element = document.getElementById(key);
            if (element) element.textContent = value.toString();
          });
        }
      }

      document.addEventListener('DOMContentLoaded', initializeDAOStats);

      // Initialize when DOM loads
      document.addEventListener('DOMContentLoaded', initializeDAOStats);

      // Wait for window.governanceContract to be available before initializing
      const checkAndInitialize = setInterval(() => {
        if (window.governanceContract) {
          clearInterval(checkAndInitialize);
          initializeDAOStats();
        }
      }, 100);
      document.addEventListener('DOMContentLoaded', async function () {
        const userAddressElement = document.getElementById('userAddress');
        // Wait for contract initialization
        async function waitForContracts() {
          return new Promise((resolve) => {
            const checkContracts = setInterval(() => {
              if (window.governanceContract && window.web3) {
                clearInterval(checkContracts);
                resolve();
              }
            }, 100);
          });
        }

        // Initialize DAO functionality
        async function initializeDAO() {
          try {
            await waitForContracts();

            // Initialize DAO stats
            const governance = window.governanceContract;
            const accounts = await window.ethereum.request({
              method: 'eth_requestAccounts',
            });
            const currentAccount = accounts[0];

            // Get all stats at once
            const [memberCount, proposalCount, quorumPercentage, votingPower] =
              await Promise.all([
                governance.methods.memberList().call(),
                governance.methods.proposalCount().call(),
                governance.methods.quorumPercentage().call(),
                governance.methods.votingPower(currentAccount).call(),
              ]);

            // Update UI
            document.getElementById('totalMembers').textContent =
              memberCount.length;
            document.getElementById('activeProposals').textContent =
              proposalCount;
            document.getElementById(
              'quorumPercentage'
            ).textContent = `${quorumPercentage}%`;
            document.getElementById('votingPower').textContent =
              window.web3.utils.fromWei(votingPower, 'ether');

            // Set up proposal form
            const proposalForm = document.querySelector('#proposalForm');
            if (proposalForm) {
              proposalForm.addEventListener('submit', async function (event) {
                event.preventDefault();

                try {
                  const description = document.getElementById(
                    'proposalDescription'
                  ).value;
                  if (!description) {
                    throw new Error('Please enter a proposal description');
                  }

                  await governance.methods
                    .createProposal(description)
                    .send({ from: currentAccount });

                  alert('Proposal created successfully!');
                  // Refresh stats after proposal creation
                  initializeDAO();
                } catch (error) {
                  console.error('Error creating proposal:', error);
                  alert(`Failed to create proposal: ${error.message}`);
                }
              });
            }
          } catch (error) {
            console.error('Error initializing DAO:', error);
            [
              'totalMembers',
              'activeProposals',
              'quorumPercentage',
              'votingPower',
            ].forEach((id) => {
              document.getElementById(id).textContent = 'Error loading';
            });
          }
        }

        // Start initialization
        initializeDAO();

        // Function to format address for display
        function formatAddress(address) {
          if (!address) return 'Not Connected';
          return `${address.slice(0, 6)}...${address.slice(-4)}`;
        }

        // Function to update wallet address display
        async function updateWalletDisplay() {
          try {
            const accounts = await window.ethereum.request({
              method: 'eth_requestAccounts',
            });
            if (accounts[0]) {
              userAddressElement.textContent = formatAddress(accounts[0]);
            }
          } catch (error) {
            console.error('Error updating wallet display:', error);
            userAddressElement.textContent = 'Error connecting wallet';
          }
        }

        // Initial wallet update
        updateWalletDisplay();

        // Listen for account changes
        window.ethereum.on('accountsChanged', function (accounts) {
          updateWalletDisplay();
        });

        // Initialize DAO stats
        async function initializeDAOStats() {
          try {
            const governance = window.governanceContract;
            if (!governance) {
              throw new Error('Governance contract not initialized');
            }

            const [
              memberCount,
              proposalCount,
              quorumPercentage,
              currentAccount,
            ] = await Promise.all([
              governance.methods.memberList().length().call(),
              governance.methods.proposalCount().call(),
              governance.methods.quorumPercentage().call(),
              window.ethereum
                .request({ method: 'eth_requestAccounts' })
                .then((accounts) => accounts[0]),
            ]);

            const votingPower = await governance.methods
              .votingPower(currentAccount)
              .call();

            // Update UI elements
            document.getElementById('totalMembers').textContent = memberCount;
            document.getElementById('activeProposals').textContent =
              proposalCount;
            document.getElementById(
              'quorumPercentage'
            ).textContent = `${quorumPercentage}%`;
            document.getElementById('votingPower').textContent =
              web3.utils.fromWei(votingPower, 'ether');
          } catch (error) {
            console.error('Error initializing DAO stats:', error);
            // Update UI to show error state
            [
              'totalMembers',
              'activeProposals',
              'quorumPercentage',
              'votingPower',
            ].forEach((id) => {
              document.getElementById(id).textContent = 'Error loading';
            });
          }
        }

        // Initialize proposal creation functionality
        function initializeProposalCreation() {
          const form = document.querySelector('form');
          if (!form) return;

          form.addEventListener('submit', async function (event) {
            event.preventDefault();

            try {
              const description = document.getElementById(
                'proposalDescription'
              ).value;
              if (!description) {
                throw new Error('Please enter a proposal description');
              }

              const governance = window.governanceContract;
              const accounts = await window.ethereum.request({
                method: 'eth_requestAccounts',
              });

              // 1. Check permissions
              const member = await governance.methods
                .members(accounts[0])
                .call();
              if (!member.isApproved) {
                throw new Error('Not a member');
              }

              if (!member.hasPassedKYC) {
                throw new Error('KYC not passed');
              }

              // 2. Verify contract state
              const votingPower = await governance.methods
                .votingPower(accounts[0])
                .call();
              if (votingPower <= 0) {
                throw new Error('No voting power');
              }

              // 3. Execute transaction
              const tx = await governance.methods
                .createProposal(description)
                .send({ from: accounts[0] });

              console.log('Proposal created:', tx);
              alert('Proposal created successfully!');

              // Refresh DAO stats
              await initializeDAOStats();
            } catch (error) {
              // 4. Handle errors
              console.error('Error creating proposal:', error);
              alert(`Failed to create proposal: ${error.message}`);
            }
          });
        }

        // Initialize all functionality
        await initializeDAOStats();
        initializeProposalCreation();
      });
    </script>
  </head>
  <body>
    <header>
      <!-- Navigation -->
      <nav class="navbar">
        <div class="logo">
          <img src="./img/IMG_5974.png" alt="Fractio logo" />
          <span>Fractio</span>
        </div>
        <div class="user-menu">
          <span id="userAddress">Not Connected</span>
          <img src="./img/IMG_5974.png" alt="User avatar" />
        </div>
      </nav>
    </header>

    <div class="layout">
      <!-- Sidebar -->
      <div class="layout">
        <aside class="sidebar">
          <div class="sidebar-item">
            <a href="./index.html">Marketplace</a>
          </div>
          <div class="sidebar-item">
            <a href="./yourEstate.html">Your Estate</a>
          </div>
          <div class="sidebar-item active">
            <a href="./DAO.html">DAO</a>
          </div>
          <div class="sidebar-item">
            <a href="./settings.html">Settings</a>
          </div>
          <div class="sidebar-item">
            <a href="./wallet.html">Wallet</a>
          </div>
          <div class="sidebar-item">
            <a href="./newListings.html">New listings</a>
          </div>
        </aside>
      </div>

      <!-- Main Content -->
      <main class="main-content">
        <div class="dao-container">
          <div class="dao-header">
            <h1>DAO Governance</h1>
          </div>

          <div class="dao-stats">
            <div class="stat-card">
              <div class="stat-title">Total Members</div>
              <div id="totalMembers" class="stat-value">Loading...</div>
            </div>
            <div class="stat-card">
              <div class="stat-title">Active Proposals</div>
              <div id="activeProposals" class="stat-value">Loading...</div>
            </div>
            <div class="stat-card">
              <div class="stat-title">Your Voting Power</div>
              <div id="votingPower" class="stat-value">Loading...</div>
            </div>
            <div class="stat-card">
              <div class="stat-title">Quorum Percentage</div>
              <div id="quorumPercentage" class="stat-value">Loading...</div>
            </div>
          </div>

          <div class="dao-sections">
            <!-- Proposal Section -->
            <section class="dao-section">
              <h2>Active Proposals</h2>
              <div id="proposalsList"></div>
            </section>

            <!-- Voting History -->
            <section class="dao-section">
              <h2>Recent Votes</h2>
              <div id="votesList"></div>
            </section>

            <!-- Create Proposal -->
            <div class="section dao-section">
              <h2>Create New Proposal</h2>
              <form id="proposalForm" class="proposal-form">
                <div class="form-group">
                  <label for="proposalTitle">Title:</label>
                  <input
                    type="text"
                    id="proposalTitle"
                    name="proposalTitle"
                    required
                    class="form-control"
                  />
                </div>
                <div class="form-group">
                  <label for="proposalDescription">Description:</label>
                  <textarea
                    id="proposalDescription"
                    name="proposalDescription"
                    required
                    class="form-control"
                  ></textarea>
                </div>
                <button type="submit" class="btn btn-primary">
                  Create Proposal
                </button>
              </form>
            </div>

            <!-- Delegation -->
            <section class="dao-section delegate-section">
              <h2>Delegate Your Voting Power</h2>
              <form id="delegateForm">
                <div class="form-group">
                  <label for="delegateAddress">Delegate Address:</label>
                  <input type="text" id="delegateAddress" required />
                </div>
                <button type="submit" class="btn btn-primary">Delegate</button>
              </form>
            </section>
          </div>
        </div>
      </main>
    </div>
  </body>
</html>
